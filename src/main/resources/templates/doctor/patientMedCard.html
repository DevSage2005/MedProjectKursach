<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Медицинская карта - Медицинский проект</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .patient-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-radius: 15px;
        }
        .medical-card-section {
            border-left: 4px solid #28a745;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .record-card {
            border-left: 4px solid #007bff;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .record-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .completed-record {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }
        .in-progress-record {
            border-left-color: #ffc107;
            background: rgba(255, 193, 7, 0.05);
        }
        .patient-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007bff, #0056b3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
        }
        .pagination-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 2rem;
        }
        .record-collapse {
            transition: all 0.3s ease;
        }
        .record-summary {
            cursor: pointer;
            padding: 1rem;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        .record-summary:hover {
            background-color: #f8f9fa;
        }
        .medical-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .info-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
        }
        .image-gallery {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }
        .image-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.25rem;
            transition: all 0.3s ease;
        }
        .image-thumbnail:hover {
            border-color: #007bff;
            transform: scale(1.05);
        }
        .image-thumbnail.active {
            border-color: #007bff;
            border-width: 3px;
        }
        .main-image-container {
            text-align: center;
            margin-bottom: 1rem;
        }
        .medical-image {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .medical-image:hover {
            transform: scale(1.02);
        }
        .image-modal .modal-dialog {
            max-width: 90%;
        }
        .image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 1000;
        }
        .image-nav.prev {
            left: 20px;
        }
        .image-nav.next {
            right: 20px;
        }
        .image-nav:hover {
            background: rgba(0,0,0,0.9);
        }
        .no-images {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        .imaging-badge {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            color: white;
        }
    </style>
</head>
<body class="bg-light">
<!-- Header -->
<header class="p-3 text-bg-dark">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-between">
            <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                <i class="fas fa-heartbeat fa-2x me-2"></i>
                <span class="fs-4">Медицинский проект</span>
            </a>
            <ul class="nav col-12 col-lg-auto mb-2 justify-content-center mb-md-0">
                <li><a th:href="@{/main/index}" class="nav-link px-2 text-secondary">Главная</a></li>
                <li><a th:href="@{/doctorPage/appointments}" class="nav-link px-2 text-white">Мои записи</a></li>
            </ul>
        </div>
    </div>
</header>

<main class="container my-5">
    <!-- Заголовок страницы -->
    <div class="patient-header p-4 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-2">
                    <i class="fas fa-clipboard-medical me-3"></i>Медицинская карта пациента
                </h1>
                <p class="lead mb-0">Полная история обращений и медицинских записей</p>
            </div>
            <div class="col-md-4 text-end">
                <a th:href="@{/doctorPage/appointments}" class="btn btn-light">
                    <i class="fas fa-arrow-left me-2"></i>Назад к записям
                </a>
            </div>
        </div>
    </div>

    <!-- Информация о пациенте -->
    <div class="card medical-card-section mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Основная информация</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <div class="patient-avatar mx-auto mb-3">
                        <span th:text="${medicalCard.user.firstName.substring(0,1) + medicalCard.user.lastName.substring(0,1)}"></span>
                    </div>
                </div>
                <div class="col-md-5">
                    <h4 th:text="${medicalCard.user.lastName + ' ' + medicalCard.user.firstName + ' ' + medicalCard.user.middleName}"></h4>
                    <p class="text-muted mb-1">
                        <i class="fas fa-phone me-2"></i>
                        <span th:text="${medicalCard.user.phone}"></span>
                    </p>
                    <p class="text-muted mb-1">
                        <i class="fas fa-envelope me-2"></i>
                        <span th:text="${medicalCard.user.email}"></span>
                    </p>
                    <p class="text-muted" th:if="${medicalCard.user.dateOfBirth != null}">
                        <i class="fas fa-birthday-cake me-2"></i>
                        <span th:text="${#dates.format(medicalCard.user.dateOfBirth, 'dd.MM.yyyy')}"></span>
                    </p>
                </div>
                <div class="col-md-5">
                    <div class="medical-info-grid">
                        <div class="info-card">
                            <h6 class="text-primary mb-2">Группа крови</h6>
                            <p class="mb-0" th:text="${medicalCard.bloodType != null ? medicalCard.bloodType : 'Не указана'}"></p>
                        </div>
                        <div class="info-card">
                            <h6 class="text-primary mb-2">Всего записей</h6>
                            <p class="mb-0" th:text="${totalRecords}"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Медицинская информация -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6><i class="fas fa-allergies me-2 text-warning"></i>Аллергии</h6>
                    <p th:if="${medicalCard.allergies != null && !medicalCard.allergies.isEmpty()}"
                       th:text="${medicalCard.allergies}" class="text-muted"></p>
                    <p th:if="${medicalCard.allergies == null || medicalCard.allergies.isEmpty()}"
                       class="text-muted">Не указаны</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-heartbeat me-2 text-danger"></i>Хронические заболевания</h6>
                    <p th:if="${medicalCard.chronicDiseases != null && !medicalCard.chronicDiseases.isEmpty()}"
                       th:text="${medicalCard.chronicDiseases}" class="text-muted"></p>
                    <p th:if="${medicalCard.chronicDiseases == null || medicalCard.chronicDiseases.isEmpty()}"
                       class="text-muted">Не указаны</p>
                </div>
            </div>

            <!-- История болезней -->
            <div class="row mt-3" th:if="${medicalCard.medicalHistory != null && !medicalCard.medicalHistory.isEmpty()}">
                <div class="col-12">
                    <h6><i class="fas fa-history me-2 text-info"></i>История болезней</h6>
                    <p th:text="${medicalCard.medicalHistory}" class="text-muted"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- История записей -->
    <div class="card medical-card-section">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-history me-2"></i>История медицинских записей
                <span class="badge bg-light text-primary ms-2" th:text="${totalRecords}"></span>
            </h5>
        </div>
        <div class="card-body">
            <!-- Статистика пагинации -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <span class="text-muted">
                        Показано
                        <strong th:text="${medicalRecords.size()}"></strong> из
                        <strong th:text="${totalRecords}"></strong> записей
                    </span>
                </div>
                <div>
                    <span class="text-muted">
                        Страница <strong th:text="${currentPage + 1}"></strong> из
                        <strong th:text="${totalPages}"></strong>
                    </span>
                </div>
            </div>

            <!-- Список записей -->
            <div th:if="${medicalRecords.isEmpty()}">
                <div class="text-center py-5">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Записей не найдено</h4>
                    <p class="text-muted">У пациента пока нет медицинских записей</p>
                </div>
            </div>

            <div th:each="record : ${medicalRecords}">
                <div class="card record-card" th:classappend="${record.status.name() == 'COMPLETED'} ? 'completed-record' : 'in-progress-record'">
                    <div class="record-summary" data-bs-toggle="collapse" th:attr="data-bs-target='#recordDetails'+${record.id}">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h6 class="mb-1">Дата приёма</h6>
                                <p class="mb-0" th:text="${#temporals.format(record.recordDate, 'dd.MM.yyyy HH:mm')}"></p>
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">Диагноз</h6>
                                <p class="mb-0">
                                    <span th:if="${record.finalDiagnosis != null && !record.finalDiagnosis.isEmpty()}"
                                          th:text="${record.finalDiagnosis}"></span>
                                    <span th:if="${record.finalDiagnosis == null || record.finalDiagnosis.isEmpty()}">
                                        <span th:if="${record.preliminaryDiagnosis != null && !record.preliminaryDiagnosis.isEmpty()}"
                                              th:text="${record.preliminaryDiagnosis}"></span>
                                        <span th:if="${(record.finalDiagnosis == null || record.finalDiagnosis.isEmpty()) && (record.preliminaryDiagnosis == null || record.preliminaryDiagnosis.isEmpty())}">
                                            Не указан
                                        </span>
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">Врач</h6>
                                <p class="mb-0" th:text="${record.doctor.firstName + ' ' + record.doctor.lastName}"></p>
                            </div>
                            <div class="col-md-3 text-end">
                                <span th:switch="${record.status.name()}" class="badge status-badge">
                                    <span th:case="'COMPLETED'" class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Завершено
                                    </span>
                                    <span th:case="'IMAGING_COMPLETED'" class="badge bg-info">
                                        <i class="fas fa-x-ray me-1"></i>Анализ готов
                                    </span>
                                    <span th:case="'IMAGING_REQUESTED'" class="badge bg-warning">
                                        <i class="fas fa-clock me-1"></i>Ожидает анализа
                                    </span>
                                    <span th:case="'IN_PROGRESS'" class="badge bg-secondary">
                                        <i class="fas fa-sync-alt me-1"></i>В процессе
                                    </span>
                                </span>
                                <!-- Бейдж с количеством снимков -->
                                <div th:if="${not record.medicalImage.isEmpty()}" class="mt-1">
                                    <span class="badge imaging-badge">
                                        <i class="fas fa-x-ray me-1"></i>
                                        <span th:text="${record.medicalImage.size()}"></span> снимков
                                    </span>
                                </div>
                                <div th:if="${record.completionDate != null}" class="mt-1">
                                    <small class="text-muted">
                                        Завершено: <span th:text="${#temporals.format(record.completionDate, 'dd.MM.yyyy')}"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Детали записи -->
                    <div class="collapse record-collapse" th:id="'recordDetails'+${record.id}">
                        <div class="card-body border-top">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-comment-medical me-2 text-primary"></i>Жалобы и симптомы</h6>
                                    <p th:if="${record.symptoms != null && !record.symptoms.isEmpty()}"
                                       th:text="${record.symptoms}" class="text-muted"></p>
                                    <p th:if="${record.symptoms == null || record.symptoms.isEmpty()}"
                                       class="text-muted">Не указаны</p>

                                    <h6 class="mt-3"><i class="fas fa-stethoscope me-2 text-success"></i>Данные осмотра</h6>
                                    <p th:if="${record.examinationNotes != null && !record.examinationNotes.isEmpty()}"
                                       th:text="${record.examinationNotes}" class="text-muted"></p>
                                    <p th:if="${record.examinationNotes == null || record.examinationNotes.isEmpty()}"
                                       class="text-muted">Не указаны</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-pills me-2 text-info"></i>План лечения</h6>
                                    <p th:if="${record.treatmentPlan != null && !record.treatmentPlan.isEmpty()}"
                                       th:text="${record.treatmentPlan}" class="text-muted"></p>
                                    <p th:if="${record.treatmentPlan == null || record.treatmentPlan.isEmpty()}"
                                       class="text-muted">Не указан</p>

                                    <h6 class="mt-3"><i class="fas fa-prescription me-2 text-warning"></i>Назначенные лекарства</h6>
                                    <p th:if="${record.prescribedMedication != null && !record.prescribedMedication.isEmpty()}"
                                       th:text="${record.prescribedMedication}" class="text-muted"></p>
                                    <p th:if="${record.prescribedMedication == null || record.prescribedMedication.isEmpty()}"
                                       class="text-muted">Не назначены</p>
                                </div>
                            </div>

                            <!-- Результаты анализов (если есть) -->
                            <div th:if="${record.imagingResults != null && !record.imagingResults.isEmpty()}" class="mt-3">
                                <h6><i class="fas fa-file-medical me-2 text-danger"></i>Заключение радиолога</h6>
                                <p th:text="${record.imagingResults}" class="text-muted"></p>
                            </div>

                            <!-- Рентгеновские снимки -->
                            <div th:if="${not record.medicalImage.isEmpty()}" class="mt-4">
                                <h6><i class="fas fa-x-ray me-2 text-info"></i>Рентгеновские снимки</h6>
                                <div class="image-gallery">
                                    <!-- Миниатюры снимков -->
                                    <div class="mb-3">
                                        <h6 class="small text-muted mb-2">Доступные снимки:</h6>
                                        <div class="d-flex flex-wrap">
                                            <div th:each="medicalImage, iter : ${record.medicalImage}">
                                                <img th:src="@{'/imageData/' + ${medicalImage.id}}"
                                                     class="image-thumbnail"
                                                     th:alt="${medicalImage.originalFileName}"
                                                     th:data-record-id="${record.id}"
                                                     th:data-image-index="${iter.index}"
                                                     onclick="showImage(this)">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Основное изображение -->
                                    <div class="main-image-container">
                                        <h6 class="small text-muted mb-2">Просмотр снимка</h6>
                                        <div th:if="${not record.medicalImage.isEmpty()}">
                                            <img th:src="@{'/imageData/' + ${record.medicalImage[0].id}}"
                                                 th:id="'mainImage'+${record.id}"
                                                 class="medical-image"
                                                 th:alt="${record.medicalImage[0].originalFileName}"
                                                 data-bs-toggle="modal"
                                                 data-bs-target="#imageModal">
                                            <div class="mt-2">
                                                <small class="text-muted" th:id="'imageCaption'+${record.id}">
                                                    <span th:text="${record.medicalImage[0].originalFileName}"></span>
                                                    <span th:if="${record.medicalImage[0].status != null}">
                                                        • Статус: <span th:text="${record.medicalImage[0].status.getTranslation()}"></span>
                                                    </span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Обработанные изображения (если есть) -->
                                    <div th:each="medicalImage : ${record.medicalImage}" th:if="${medicalImage.processedFilePath != null}">
                                        <div class="main-image-container mt-3">
                                            <h6 class="small text-muted mb-2">Обработанный снимок</h6>
                                            <img th:src="@{'/imageData/processedImage/' + ${medicalImage.id}}"
                                                 class="medical-image"
                                                 th:alt="'Обработанный ' + ${medicalImage.originalFileName}"
                                                 data-bs-toggle="modal"
                                                 data-bs-target="#imageModal">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Сообщение об отсутствии снимков -->
                            <div th:if="${record.medicalImage.isEmpty()}" class="mt-3">
                                <div class="no-images">
                                    <i class="fas fa-x-ray fa-2x mb-2"></i>
                                    <p class="mb-0">Рентгеновские снимки отсутствуют</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Пагинация -->
            <div th:if="${totalPages > 1}" class="pagination-container">
                <nav aria-label="Навигация по записям">
                    <ul class="pagination justify-content-center mb-0">
                        <!-- Первая страница -->
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{'/doctorPage/showMedicalCard/' + ${medicalCard.id} + '?page=0&size=' + pageSize}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>

                        <!-- Предыдущая страница -->
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{'/doctorPage/showMedicalCard/' + ${medicalCard.id} + '?page=' + (currentPage - 1) + '&size=' + pageSize}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>

                        <!-- Номера страниц -->
                        <li th:each="pageNum : ${#numbers.sequence(1, totalPages)}"
                            class="page-item" th:classappend="${(pageNum - 1) == currentPage} ? 'active'">
                            <a class="page-link"
                               th:href="@{'/doctorPage/showMedicalCard/' + ${medicalCard.id} + '?page=' + (pageNum - 1) + '&size=' + pageSize}"
                               th:text="${pageNum}"></a>
                        </li>

                        <!-- Следующая страница -->
                        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''">
                            <a class="page-link"
                               th:href="@{/doctorPage/showMedicalCard/{id}(id=${medicalCard.id}, page=${currentPage + 1}, size=${pageSize})}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>

                        <!-- Последняя страница -->
                        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                            <a class="page-link" th:href="@{'/doctorPage/showMedicalCard/' + ${medicalCard.id} + '?page=' + (totalPages - 1) + '&size=' + pageSize}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- Выбор количества записей на странице -->
                <div class="text-center mt-3">
                    <small class="text-muted">Записей на странице:</small>
                    <div class="btn-group btn-group-sm ms-2">
                        <a class="btn btn-outline-secondary"
                           th:classappend="${pageSize == 5} ? 'active'"
                           th:href="@{'/doctorPage/showMedicalCard/' + ${medicalCard.id} + '?page=0&size=5'}">5</a>
                        <a class="btn btn-outline-secondary"
                           th:classappend="${pageSize == 10} ? 'active'"
                           th:href="@{'/doctorPage/showMedicalCard/' + ${medicalCard.id} + '?page=0&size=10'}">10</a>
                        <a class="btn btn-outline-secondary"
                           th:classappend="${pageSize == 20} ? 'active'"
                           th:href="@{'/doctorPage/showMedicalCard/' + ${medicalCard.id} + '?page=0&size=20'}">20</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Модальное окно для просмотра изображений -->
<div class="modal fade image-modal" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalImageTitle">Просмотр снимка</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center position-relative">
                <button class="image-nav prev" onclick="navigateImage(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <img id="modalImage" src="" class="img-fluid" style="max-height: 70vh;">
                <button class="image-nav next" onclick="navigateImage(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="modal-footer">
                <small class="text-muted" id="modalImageInfo"></small>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="bg-dark text-white py-4 mt-5">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h5><i class="fas fa-heartbeat me-2"></i>Медицинский проект</h5>
                <p class="mb-0">Ваше здоровье - наша забота</p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="mb-0">© 2025 Медицинский проект. Все права защищены.</p>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentImageIndex = 0;
    let currentRecordImages = [];

    // Показ изображения в основном контейнере
    function showImage(element) {
        const recordId = element.dataset.recordId;
        const imageIndex = parseInt(element.dataset.imageIndex);
        const mainImage = document.getElementById('mainImage' + recordId);
        const imageCaption = document.getElementById('imageCaption' + recordId);

        mainImage.src = element.src;
        mainImage.alt = element.alt;

        // Обновляем подпись
        const imageData = getImageDataForRecord(recordId)[imageIndex];
        if (imageData) {
            imageCaption.innerHTML = `
                ${imageData.alt}
                <span th:if="${imageData.status != null}">
                    • Статус: <span th:text="${imageData.status?.getTranslation()}"></span>
                </span>
            `;
        }

        // Обновляем активную миниатюру
        document.querySelectorAll('[data-record-id="' + recordId + '"]').forEach(thumb => {
            thumb.classList.remove('active');
        });
        element.classList.add('active');

        currentImageIndex = imageIndex;
        currentRecordImages = getImageDataForRecord(recordId);
    }

    // Получение данных изображений для конкретной записи
    function getImageDataForRecord(recordId) {
        const thumbnails = document.querySelectorAll('[data-record-id="' + recordId + '"]');
        const images = [];
        thumbnails.forEach(thumb => {
            images.push({
                src: thumb.src,
                alt: thumb.alt,
                index: parseInt(thumb.dataset.imageIndex),
                status: thumb.dataset.status
            });
        });
        return images;
    }

    // Навигация по изображениям в модальном окне
    function navigateImage(direction) {
        currentImageIndex += direction;

        if (currentImageIndex < 0) {
            currentImageIndex = currentRecordImages.length - 1;
        } else if (currentImageIndex >= currentRecordImages.length) {
            currentImageIndex = 0;
        }

        const imageData = currentRecordImages[currentImageIndex];
        document.getElementById('modalImage').src = imageData.src;
        document.getElementById('modalImageTitle').textContent = 'Просмотр снимка';
        document.getElementById('modalImageInfo').textContent = imageData.alt;
    }

    // Обработка модального окна
    document.getElementById('imageModal').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const imageSrc = button.src;
        const imageAlt = button.alt;

        document.getElementById('modalImage').src = imageSrc;
        document.getElementById('modalImageTitle').textContent = 'Просмотр снимка';
        document.getElementById('modalImageInfo').textContent = imageAlt;

        // Находим индекс текущего изображения
        currentImageIndex = currentRecordImages.findIndex(img => img.src === imageSrc);
    });

    // Автоматическое раскрытие первой записи
    document.addEventListener('DOMContentLoaded', function() {
        const firstRecord = document.querySelector('.record-collapse');
        if (firstRecord) {
            new bootstrap.Collapse(firstRecord, {
                toggle: true
            });
        }
    });
</script>
</body>
</html>