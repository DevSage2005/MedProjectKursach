<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Обработка изображения - Медицинский проект</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .processing-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px;
        }
        .image-container {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            background: #f8f9fa;
        }
        .processed-image {
            max-width: 100%;
            max-height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .controls-panel {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1.5rem;
        }
        .param-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        .btn-process {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: white;
        }
        .btn-process:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            color: white;
        }
        .slider-value {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .risk-high {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
        }
        .risk-medium {
            border-left: 4px solid #ffc107;
            background: #fff3cd;
        }
        .risk-low {
            border-left: 4px solid #0dcaf0;
            background: #d1ecf1;
        }
        .pathology-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .pathology-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .confidence-bar {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .analysis-loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .btn-save-results {
            background: linear-gradient(45deg, #0d6efd, #0dcaf0);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            color: white;
        }
        .btn-save-results:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
            color: white;
        }
    </style>
</head>
<body class="bg-light">
<!-- Header -->
<header class="p-3 text-bg-dark">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-between">
            <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                <i class="fas fa-heartbeat fa-2x me-2"></i>
                <span class="fs-4">Медицинский проект</span>
            </a>
            <ul class="nav col-12 col-lg-auto mb-2 justify-content-center mb-md-0">
                <li><a th:href="@{/main/index}" class="nav-link px-2 text-secondary">Главная</a></li>
                <li><a th:href="@{/radiologistPage/analysis}" class="nav-link px-2 text-white">Анализы</a></li>
            </ul>
        </div>
    </div>
</header>

<main class="container my-5">
    <!-- Заголовок страницы -->
    <div class="processing-header p-4 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-2">
                    <i class="fas fa-magic me-3"></i>Обработка изображения
                </h1>
                <p class="lead mb-0">Просмотр и преобразование медицинского снимка</p>
            </div>
            <div class="col-md-4 text-end">
                <a th:href="@{/radiologistPage/analysis}" class="btn btn-light">
                    <i class="fas fa-arrow-left me-2"></i>Назад к списку
                </a>
            </div>
        </div>
    </div>

    <!-- Информация о пациенте -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <p><strong>Пациент:</strong>
                        <span th:text="${medicalRecord.medicalCard.user.firstName + ' ' + medicalRecord.medicalCard.user.lastName}"></span>
                    </p>
                    <p><strong>Тип исследования:</strong>
                        <span class="badge bg-info" th:text="${medicalRecord.imagingType.getDescription()}"></span>
                    </p>
                </div>
                <div class="col-md-4">
                    <p><strong>Файл:</strong>
                        <span th:text="${medicalImage.originalFileName}"></span>
                    </p>
                    <p><strong>Размер:</strong>
                        <span th:text="${#numbers.formatDecimal(medicalImage.fileSize / 1024.0 / 1024.0, 1, 2)} + ' MB'"></span>
                    </p>
                </div>
                <div class="col-md-4">
                    <p><strong>Дата загрузки:</strong>
                        <span th:text="${#temporals.format(medicalImage.uploadedAt, 'dd.MM.yyyy HH:mm')}"></span>
                    </p>
                    <p><strong>Статус:</strong>
                        <span class="badge" th:classappend="'bg-' + ${analysisSummary?.badgeColor ?: 'secondary'}"
                              th:text="${analysisSummary?.statusText ?: medicalImage.status.getTranslation()}"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Панель управления -->
        <div class="col-lg-4">
            <div class="controls-panel shadow-sm">
                <h4 class="mb-4"><i class="fas fa-sliders-h me-2"></i>Параметры обработки</h4>

                <form th:action="@{/imageData/getProcessedImage/{imageId}(imageId=${medicalImage.id})}"
                      th:method="POST" id="processForm">

                    <!-- AI Анализ -->
                    <div class="param-group">
                        <h6><i class="fas fa-robot me-2"></i>AI Анализ</h6>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="analyze" id="analyze" value="true">
                            <label class="form-check-label" for="analyze">
                                <strong>Включить AI анализ</strong>
                            </label>
                            <small class="form-text text-muted d-block">
                                Автоматическое обнаружение патологий на снимке
                            </small>
                        </div>
                    </div>

                    <!-- Контраст и яркость -->
                    <div class="param-group">
                        <h6>Контраст и яркость</h6>
                        <div class="mb-3">
                            <label class="form-label">Контраст</label>
                            <input type="range" class="form-range" name="contrast" min="0.1" max="10.0" step="0.1"
                                   value="1.0"
                                   oninput="document.getElementById('contrastValue').textContent = this.value">
                            <div class="d-flex justify-content-between">
                                <small>Меньше</small>
                                <span class="slider-value" id="contrastValue">1.0</span>
                                <small>Больше</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Яркость</label>
                            <input type="range" class="form-range" name="brightness" min="0" max="100" step="1"
                                   value="0"
                                   oninput="document.getElementById('brightnessValue').textContent = this.value">
                            <div class="d-flex justify-content-between">
                                <small>Темнее</small>
                                <span class="slider-value" id="brightnessValue">0</span>
                                <small>Светлее</small>
                            </div>
                        </div>
                    </div>

                    <!-- Фильтры -->
                    <div class="param-group">
                        <h6>Фильтры</h6>
                        <div class="mb-3">
                            <label class="form-label">Резкость</label>
                            <input type="range" class="form-range" name="sharpness" min="0.5" max="10" step="0.25" value="0.5"
                                   oninput="document.getElementById('sharpnessValue').textContent = this.value">
                            <div class="d-flex justify-content-between">
                                <small>Мягко</small>
                                <span class="slider-value" id="sharpnessValue">0.5</span>
                                <small>Резко</small>
                            </div>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="grayscale" id="grayscale">
                            <label class="form-check-label" for="grayscale">Черно-белый фильтр</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="enhance" id="enhance">
                            <label class="form-check-label" for="enhance">Улучшение деталей</label>
                        </div>
                    </div>

                    <!-- Кнопки действий -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-process">
                            <i class="fas fa-play me-2"></i>Применить обработку
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="fas fa-redo me-2"></i>Сбросить настройки
                        </button>
                        <button type="button" class="btn btn-primary" onclick="runAIAnalysis()" id="aiAnalyzeBtn">
                            <i class="fas fa-brain me-2"></i>Запустить AI анализ
                        </button>
                    </div>
                </form>
            </div>

            <!-- Быстрая статистика анализа -->
            <div th:if="${analysisSummary != null}" class="mt-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Статистика анализа</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-primary fw-bold" th:text="${analysisSummary.totalFindings}">0</div>
                                <small class="text-muted">Всего находок</small>
                            </div>
                            <div class="col-4">
                                <div class="text-danger fw-bold" th:text="${analysisSummary.highRiskFindings}">0</div>
                                <small class="text-muted">Критических</small>
                            </div>
                            <div class="col-4">
                                <div class="text-warning fw-bold" th:text="${analysisSummary.mediumRiskFindings}">0</div>
                                <small class="text-muted">Средних</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Область просмотра изображения и результатов -->
        <div class="col-lg-8">
            <!-- Индикатор загрузки AI анализа -->
            <div class="analysis-loading" id="analysisLoading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-3">AI анализ выполняется... Это может занять несколько секунд</p>
            </div>

            <div class="image-container shadow-sm">
                <div class="text-center mb-3">
                    <h5><i class="fas fa-image me-2"></i>Просмотр снимка</h5>
                </div>

                <!-- Оригинальное изображение -->
                <div class="mb-4">
                    <h6>Оригинальное изображение</h6>
                    <div class="text-center">
                        <img th:src="@{'/imageData/' + ${medicalImage.id}}"
                             alt="Медицинский снимок" class="processed-image" id="originalImage">
                    </div>
                </div>

                <!-- Обработанное изображение -->
                <div th:if="${medicalImage.processedFilePath != null and !medicalImage.processedFilePath.isEmpty()}"
                     class="mb-4">
                    <h6>Обработанное изображение</h6>
                    <div class="text-center">
                        <img th:src="@{/imageData/processedImage/{imageId}(imageId=${medicalImage.id})}"
                             alt="Обработанный снимок" class="processed-image" id="processedImage">
                    </div>
                </div>
            </div>

            <!-- Результаты AI анализа -->
            <div th:if="${analysisResults != null}" class="mt-4">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-robot me-2"></i>Результаты AI анализа</h6>
                    </div>
                    <div class="card-body">
                        <!-- Критические находки -->
                        <div th:if="${analysisResults.highRisk != null and !analysisResults.highRisk.isEmpty()}">
                            <h6 class="text-danger mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>Критические находки
                                <span class="badge bg-danger" th:text="${analysisResults.highRisk.size()}"></span>
                            </h6>
                            <div th:each="finding : ${analysisResults.highRisk}" class="mb-3">
                                <div class="card pathology-card risk-high">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1" th:text="${finding.pathology}">Патология</h6>
                                                <p class="card-text text-muted mb-2">
                                                    Высокий риск - требует немедленного внимания
                                                </p>
                                            </div>
                                            <span class="badge bg-danger" th:text="${finding.confidence}">95%</span>
                                        </div>
                                        <div class="confidence-bar mt-2">
                                            <div class="confidence-fill bg-danger"
                                                 th:style="'width: ' + ${finding.probability * 100} + '%;'"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Средний риск -->
                        <div th:if="${analysisResults.mediumRisk != null and !analysisResults.mediumRisk.isEmpty()}">
                            <h6 class="text-warning mb-3">
                                <i class="fas fa-info-circle me-2"></i>Средний риск
                                <span class="badge bg-warning" th:text="${analysisResults.mediumRisk.size()}"></span>
                            </h6>
                            <div th:each="finding : ${analysisResults.mediumRisk}" class="mb-3">
                                <div class="card pathology-card risk-medium">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1" th:text="${finding.pathology}">Патология</h6>
                                                <p class="card-text text-muted mb-2">
                                                    Умеренный риск - требует наблюдения
                                                </p>
                                            </div>
                                            <span class="badge bg-warning" th:text="${finding.confidence}">45%</span>
                                        </div>
                                        <div class="confidence-bar mt-2">
                                            <div class="confidence-fill bg-warning"
                                                 th:style="'width: ' + ${finding.probability * 100} + '%;'"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Низкий риск -->
                        <div th:if="${analysisResults.lowRisk != null and !analysisResults.lowRisk.isEmpty()}">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-check-circle me-2"></i>Низкий риск
                                <span class="badge bg-info" th:text="${analysisResults.lowRisk.size()}"></span>
                            </h6>
                            <div th:each="finding : ${analysisResults.lowRisk}" class="mb-3">
                                <div class="card pathology-card risk-low">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1" th:text="${finding.pathology}">Патология</h6>
                                                <p class="card-text text-muted mb-2">
                                                    Минимальный риск
                                                </p>
                                            </div>
                                            <span class="badge bg-info" th:text="${finding.confidence}">15%</span>
                                        </div>
                                        <div class="confidence-bar mt-2">
                                            <div class="confidence-fill bg-info"
                                                 th:style="'width: ' + ${finding.probability * 100} + '%;'"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Нет находок -->
                        <div th:if="${analysisResults.totalFindings == 0}">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h5>Патологий не обнаружено</h5>
                                <p>AI анализ не выявил значимых патологий на снимке</p>
                            </div>
                        </div>

                        <!-- Общая статистика -->
                        <div class="mt-4 pt-3 border-top">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="h4" th:text="${analysisResults.totalFindings}">0</div>
                                    <small class="text-muted">Всего находок</small>
                                </div>
                                <div class="col-4">
                                    <div class="h4 text-danger"
                                         th:text="${analysisResults.criticalFindings}">0</div>
                                    <small class="text-muted">Критических</small>
                                </div>
                                <div class="col-4">
                                    <div class="h4 text-success"
                                         th:text="${#temporals.format(analysisPerformedAt, 'HH:mm')}">-</div>
                                    <small class="text-muted">Время анализа</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Форма для результатов анализа радиолога -->
            <div class="mt-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Результаты анализа радиолога</h6>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/radiologistPage/saveAnalizResult/{id}(id=${medicalRecord.id})}"
                              th:method="POST" id="radiologistForm">

                            <div class="mb-3">
                                <label for="imagingResults" class="form-label">Результаты анализа снимка *</label>
                                <textarea class="form-control" id="imagingResults" name="imagingResults"
                                          rows="6" placeholder="Опишите обнаруженные патологии, изменения, аномалии..."
                                          th:text="${medicalRecord.imagingResults}" required></textarea>
                                <div class="form-text">
                                    Подробно опишите все обнаруженные изменения на снимке
                                </div>
                            </div>

                            <!-- Скрытые поля для сохранения остальных данных -->
                            <input type="hidden" name="id" th:value="${medicalRecord.id}">
                            <input type="hidden" name="symptoms" th:value="${medicalRecord.symptoms}">
                            <input type="hidden" name="examinationNotes" th:value="${medicalRecord.examinationNotes}">
                            <input type="hidden" name="preliminaryDiagnosis" th:value="${medicalRecord.preliminaryDiagnosis}">
                            <input type="hidden" name="clinicalQuestion" th:value="${medicalRecord.clinicalQuestion}">

                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-save-results">
                                    <i class="fas fa-check-circle me-2"></i>Сохранить результаты
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    function resetForm() {
        document.getElementById('processForm').reset();
        document.getElementById('contrastValue').textContent = '1.0';
        document.getElementById('brightnessValue').textContent = '0';
        document.getElementById('sharpnessValue').textContent = '0.5';
    }

    // Функция для запуска AI анализа через AJAX
    function runAIAnalysis() {
        const btn = document.getElementById('aiAnalyzeBtn');
        const loading = document.getElementById('analysisLoading');

        // Показываем индикатор загрузки
        loading.style.display = 'block';
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Анализ выполняется...';

        // AJAX запрос к серверу
        fetch(`/imageData/analyze/${getImageId()}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                // Скрываем индикатор загрузки
                loading.style.display = 'none';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-brain me-2"></i>Запустить AI анализ';

                if (data.error) {
                    showAlert('Ошибка: ' + data.details, 'danger');
                } else {
                    showAlert('AI анализ успешно завершен!', 'success');
                    // Перезагружаем страницу для отображения результатов
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                loading.style.display = 'none';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-brain me-2"></i>Запустить AI анализ';
                showAlert('Ошибка при выполнении анализа', 'danger');
            });
    }

    // Вспомогательная функция для получения ID изображения
    function getImageId() {
        return window.location.pathname.split('/').pop();
    }

    // Функция для показа уведомлений
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.querySelector('main').insertBefore(alertDiv, document.querySelector('main').firstChild);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Валидация формы радиолога
    document.getElementById('radiologistForm').addEventListener('submit', function(e) {
        const imagingResults = document.getElementById('imagingResults').value;

        if (!imagingResults.trim()) {
            e.preventDefault();
            showAlert('Пожалуйста, заполните поле "Результаты анализа снимка"', 'warning');
            return;
        }

        showAlert('Результаты сохраняются...', 'info');
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>